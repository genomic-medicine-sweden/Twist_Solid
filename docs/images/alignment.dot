digraph snakemake_dag {
    rankdir=LR;
    graph[bgcolor=white, margin=0];
    node[shape=box, style=rounded, fontname=sans, fontsize=10, penwidth=2];
    edge[penwidth=2, color=grey];

    // Source
    8[label = "trimmed fastq", color = "0.0 0.0 0.0", style="dotted"];

    // Common initial alignment
    5[label = "bwa_mem", color = "0.43 0.6 0.85", style="rounded"];
    4[label = "bwa_mem_merge", color = "0.31 0.6 0.85", style="rounded"];

    8 -> 5
    5 -> 4

    subgraph cluster_ffpe {
        label = "FFPE Path";
        color = lightgrey;
        style = dashed;

        f1[label = "filter_reads", color = "0.1 0.6 0.85", style="rounded"];
        f1f[label = "filter (fusions)", color = "0.1 0.6 0.85", style="rounded"];
        s1[label = "sort (FFPE)", color = "0.53 0.6 0.85", style="rounded"];
        o1[label = "overlapping_bases", color = "0.80 0.6 0.85", style="rounded"];
        m1[label = "merge_final", color = "0.64 0.6 0.85", style="rounded"];
        
        f1 -> s1
        s1 -> o1
        o1 -> m1
        f1f -> m1
    }

    subgraph cluster_umi {
        label = "UMI (ctDNA) Path";
        color = lightblue;
        style = dashed;

        f2[label = "filter (umi)", color = "0.1 0.6 0.85", style="rounded"];
        f2f[label = "filter (umi fusions)", color = "0.1 0.6 0.85", style="rounded"];
        f2fu[label = "filter (fgbio fusions)", color = "0.1 0.6 0.85", style="rounded"];
        s0[label = "sort (bwa_mem)", color = "0.53 0.6 0.85", style="rounded"];
        20[label = "copy_umi", color = "0.70 0.6 0.85", style="rounded"];
        21[label = "group_reads", color = "0.75 0.6 0.85", style="rounded"];
        22[label = "call_consensus", color = "0.80 0.6 0.85", style="rounded"];
        m2[label = "merge_umi", color = "0.64 0.6 0.85", style="rounded"];
        re[label = "realign", color = "0.43 0.6 0.85", style="rounded"];
        s2[label = "sort (ctDNA)", color = "0.53 0.6 0.85", style="rounded"];
        o2[label = "overlapping_bases (umi)", color = "0.80 0.6 0.85", style="rounded"];
        m3[label = "merge_umi2", color = "0.64 0.6 0.85", style="rounded"];
        
        s0 -> f2
        s0 -> f2f
        f2 -> 20
        20 -> 21
        21 -> 22
        22 -> m2
        f2f -> m2
        m2 -> re
        re -> s2
        s2 -> o2
        s2 -> f2fu
        o2 -> m3
        f2fu -> m3
    }

    // FFPE edges
    4 -> f1 [label="fgbio=true"]
    4 -> f1f [label="fgbio=true"]
    4 -> 3 [label="fgbio=false"]

    // UMI edges
    4 -> f2
    4 -> f2f

    // Shared processing (Sort/Index)
    3[label = "sort", color = "0.53 0.6 0.85", style="rounded"];
    7[label = "index", color = "0.60 0.6 0.85", style="rounded"];
    
    m1 -> 3
    m3 -> 3
    3 -> 7
    
    // Final extraction and deduplication (placed to the right)
    ex1[label = "extract", color = "0.37 0.6 0.85", style="rounded"];
    ex2[label = "extract (UMI)", color = "0.37 0.6 0.85", style="rounded"];
    1[label = "mark_duplicates (FFPE)", color = "0.27 0.6 0.85", style="rounded"];

    7 -> ex1
    7 -> ex2
    ex1 -> 1

    // Force extraction (umi) and Picard to the far right
    { rank = same; 1; ex2; }
}
            
