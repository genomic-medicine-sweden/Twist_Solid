digraph snakemake_dag {
    rankdir=LR;
    graph[bgcolor=white, margin=0];
    node[shape=box, style=rounded, fontname=sans, fontsize=10, penwidth=2];
    edge[penwidth=2, color=grey];

    // Source
    8[label = "trimmed fastq", color = "0.0 0.0 0.0", style="dotted"];

    // Common initial alignment
    5[label = "bwa_mem", color = "0.43 0.6 0.85", style="rounded"];
    4[label = "bwa_mem_merge", color = "0.31 0.6 0.85", style="rounded"];

    8 -> 5
    5 -> 4

    subgraph cluster_ffpe {
        label = "FFPE Path";
        color = lightgrey;
        style = dashed;

        f1[label = "samtools_filter_reads", color = "0.1 0.6 0.85", style="rounded"];
        f1f[label = "samtools_filter (fusions)", color = "0.1 0.6 0.85", style="rounded"];
        o1[label = "fgbio_overlapping_bases", color = "0.80 0.6 0.85", style="rounded"];
        m1[label = "samtools_merge_bam_final", color = "0.64 0.6 0.85", style="rounded"];
        
        f1 -> o1
        o1 -> m1
        f1f -> m1
    }

    subgraph cluster_umi {
        label = "UMI (ctDNA) Path";
        color = lightblue;
        style = dashed;

        f2[label = "samtools_filter (umi)", color = "0.1 0.6 0.85", style="rounded"];
        f2f[label = "samtools_filter (umi fusions)", color = "0.1 0.6 0.85", style="rounded"];
        20[label = "fgbio_copy_umi", color = "0.70 0.6 0.85", style="rounded"];
        21[label = "fgbio_group_reads", color = "0.75 0.6 0.85", style="rounded"];
        22[label = "fgbio_call_consensus", color = "0.80 0.6 0.85", style="rounded"];
        m2[label = "samtools_merge_bam_umi", color = "0.64 0.6 0.85", style="rounded"];
        re[label = "bwa_mem_realign", color = "0.43 0.6 0.85", style="rounded"];
        o2[label = "fgbio_overlapping_bases (umi)", color = "0.80 0.6 0.85", style="rounded"];
        
        f2 -> 20
        20 -> 21
        21 -> 22
        22 -> m2
        f2f -> m2
        m2 -> re
        re -> o2
    }

    4 -> f1
    4 -> f1f
    4 -> f2
    4 -> f2f

    // Shared processing (Sort/Index)
    3[label = "samtools_sort", color = "0.53 0.6 0.85", style="rounded"];
    7[label = "samtools_index", color = "0.60 0.6 0.85", style="rounded"];

    m1 -> 3
    o2 -> 3
    3 -> 7
    
    // Final extraction and deduplication (placed to the right)
    ex1[label = "samtools_extract_reads", color = "0.37 0.6 0.85", style="rounded"];
    ex2[label = "samtools_extract_reads (UMI)", color = "0.37 0.6 0.85", style="rounded"];
    1[label = "picard_mark_duplicates (FFPE)", color = "0.27 0.6 0.85", style="rounded"];

    7 -> ex1
    7 -> ex2
    ex1 -> 1

    // Force extraction (umi) and Picard to the far right
    { rank = same; 1; ex2; }
}
            
